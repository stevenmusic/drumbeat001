<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Drum Practice - Rhythm Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow text selection in pattern cards */
        .pattern-notation {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #6a1b9a;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }
        
        /* Disable scroll only when metronome is playing */
        body.playing {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        header {
            text-align: center;
            padding: 15px 0;
            background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%);
            border-radius: 20px;
            box-shadow: 0 6px 15px rgba(186, 104, 200, 0.3);
            border: 3px solid #fff;
            flex-shrink: 0;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(106, 27, 154, 0.3);
            font-weight: bold;
        }

        .subtitle {
            color: #fff;
            font-size: 1em;
            font-weight: 400;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 80vh;
            min-height: 600px;
        }

        /* ÁØÄÊãçÂô®ÂçÄÂüü - ÊîæÂú®‰∏äÊñπ */
        .metronome-section {
            background: linear-gradient(135deg, #fff 0%, #f8e5ff 100%);
            border-radius: 20px;
            padding: 15px 20px;
            border: 3px solid #ce93d8;
            box-shadow: 0 6px 15px rgba(206, 147, 216, 0.3);
            flex-shrink: 0;
        }

        .metronome-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .bpm-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bpm-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #ab47bc;
            text-shadow: 2px 2px 4px rgba(171, 71, 188, 0.3);
            min-width: 80px;
            text-align: center;
        }

        .bpm-label {
            font-size: 1em;
            color: #8e24aa;
            font-weight: bold;
        }

        /* ÈºìÁµÑÂçÄÂüü - ‰ΩîÊìöÂ§ßÈÉ®ÂàÜÁ©∫Èñì */
        .drum-kit-section {
            background: linear-gradient(135deg, #fff 0%, #f8e5ff 100%);
            border-radius: 20px;
            padding: 20px;
            border: 3px solid #ce93d8;
            box-shadow: 0 6px 15px rgba(206, 147, 216, 0.3);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #8e24aa;
            text-align: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .drum-container {
            width: 100%;
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            min-height: 0;
        }

        .drum-zone {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .drum {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15), inset 0 2px 5px rgba(255, 255, 255, 0.5);
            position: relative;
        }

        .drum::before {
            content: attr(data-hand);
            position: absolute;
            top: 8px;
            font-size: 0.6em;
            opacity: 0.6;
        }

        .drum:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(206, 147, 216, 0.5);
        }

        .drum:active {
            transform: scale(0.95);
        }

        .drum.hit {
            animation: drumHit 0.4s ease;
        }

        @keyframes drumHit {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); box-shadow: 0 0 30px rgba(206, 147, 216, 0.8); }
        }

        /* ÈºìÁöÑ‰ΩçÁΩÆ - Â∑¶‰∏äËßí Tom1 */
        .tom1-zone {
            grid-column: 1;
            grid-row: 1;
        }

        .tom1-left, .tom1-right {
            background: linear-gradient(145deg, #b39ddb, #9575cd);
            border: 5px solid #7e57c2;
            color: #4a148c;
        }

        /* Âè≥‰∏äËßí Tom2 */
        .tom2-zone {
            grid-column: 2;
            grid-row: 1;
        }

        .tom2-left, .tom2-right {
            background: linear-gradient(145deg, #ffccbc, #ffab91);
            border: 5px solid #ff8a65;
            color: #d84315;
        }

        /* Â∑¶‰∏ãËßí Snare */
        .snare-zone {
            grid-column: 1;
            grid-row: 2;
        }

        .snare-left, .snare-right {
            background: linear-gradient(145deg, #e1bee7, #ce93d8);
            border: 5px solid #ba68c8;
            color: #6a1b9a;
        }

        /* Âè≥‰∏ãËßí Tom3 */
        .tom3-zone {
            grid-column: 2;
            grid-row: 2;
        }

        .tom3-left, .tom3-right {
            background: linear-gradient(145deg, #b3e5fc, #81d4fa);
            border: 5px solid #4fc3f7;
            color: #01579b;
        }

        /* ÁØÄÊãçÂô®ÂçÄÂüü */
        .metronome-section {
            background: linear-gradient(135deg, #fff 0%, #f8e5ff 100%);
            border-radius: 25px;
            padding: 30px;
            border: 3px solid #ce93d8;
            box-shadow: 0 8px 20px rgba(206, 147, 216, 0.3);
        }

        .metronome-display {
            text-align: center;
            margin: 30px 0;
        }

        .bpm-display {
            font-size: 4em;
            font-weight: bold;
            color: #ab47bc;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(171, 71, 188, 0.3);
        }

        .bpm-label {
            font-size: 1.3em;
            color: #8e24aa;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .bpm-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bpm-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ce93d8, #ba68c8);
            border: 3px solid #fff;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(206, 147, 216, 0.3);
            flex-shrink: 0;
        }

        .bpm-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 15px rgba(206, 147, 216, 0.5);
        }

        .bpm-btn:active {
            transform: scale(0.95);
        }

        .bpm-slider {
            flex: 1;
            min-width: 150px;
        }

        input[type="range"] {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #e1bee7, #ce93d8, #ba68c8);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(145deg, #fff, #f3e5f5);
            cursor: pointer;
            border: 3px solid #ba68c8;
            box-shadow: 0 2px 8px rgba(186, 104, 200, 0.5);
        }

        .control-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .metronome-btn {
            padding: 12px 25px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid #fff;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        .start-btn {
            background: linear-gradient(145deg, #81c784, #66bb6a);
            color: white;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(129, 199, 132, 0.5);
        }

        .stop-btn {
            background: linear-gradient(145deg, #e57373, #ef5350);
            color: white;
        }

        .stop-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(239, 83, 80, 0.5);
        }

        .beat-indicator {
            display: flex;
            gap: 10px;
            flex: 1;
            justify-content: center;
        }

        .beat-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e1bee7;
            border: 3px solid #ce93d8;
            transition: all 0.15s ease;
        }

        .beat-dot.active {
            background: linear-gradient(145deg, #ba68c8, #ab47bc);
            border-color: #8e24aa;
            box-shadow: 0 0 15px rgba(186, 104, 200, 0.8);
            transform: scale(1.3);
        }

        /* Patterns Section - At Bottom */
        .patterns-section {
            background: linear-gradient(135deg, #fff 0%, #f8e5ff 100%);
            border-radius: 25px;
            padding: 30px;
            border: 3px solid #ce93d8;
            box-shadow: 0 8px 20px rgba(206, 147, 216, 0.3);
            margin-bottom: 20px;
        }

        .patterns-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #8e24aa;
            text-align: center;
            font-weight: bold;
        }

        .patterns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pattern-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #ce93d8;
        }

        .pattern-card:hover {
            transform: translateY(-5px) rotate(1deg);
            border-color: #ba68c8;
            box-shadow: 0 10px 25px rgba(186, 104, 200, 0.4);
        }

        .pattern-card.active {
            border-color: #ef5350;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            box-shadow: 0 0 30px rgba(239, 83, 80, 0.5);
        }

        .pattern-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #7b1fa2;
            margin-bottom: 10px;
        }

        .pattern-description {
            color: #8e24aa;
            font-size: 0.95em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .pattern-notation {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #6a1b9a;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.8;
            border: 2px solid #e1bee7;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 15px;
            border: 2px solid #ce93d8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #6a1b9a;
            font-weight: 600;
        }

        .legend-symbol {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #ab47bc;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.6);
            padding: 2px 6px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                gap: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .main-content {
                height: 70vh;
                min-height: 500px;
            }

            .metronome-display {
                flex-direction: column;
                gap: 10px;
            }

            .bpm-display {
                font-size: 2em;
            }

            .drum {
                font-size: 1.2em;
            }

            .metronome-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .patterns-section {
                padding: 20px;
            }

            .patterns-title {
                font-size: 1.3em;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .drum {
                font-size: 1.4em;
            }

            .main-content {
                height: 75vh;
                min-height: 550px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•Å Drum Practice</h1>
            <p class="subtitle">iPad Touch Version - Rhythm Game</p>
        </header>

        <div class="main-content">
            <!-- Metronome Section - On Top -->
            <div class="metronome-section">
                <div class="metronome-display">
                    <div class="bpm-section">
                        <div class="bpm-label">BPM</div>
                        <div class="bpm-display" id="bpmDisplay">90</div>
                    </div>
                    
                    <div class="bpm-controls">
                        <button class="bpm-btn" id="bpmDown">‚àí</button>
                        <div class="bpm-slider">
                            <input type="range" id="bpmSlider" min="40" max="240" value="90">
                        </div>
                        <button class="bpm-btn" id="bpmUp">+</button>
                    </div>

                    <div class="control-section">
                        <button class="metronome-btn start-btn" id="startBtn">‚ñ∂ Start</button>
                        <button class="metronome-btn stop-btn" id="stopBtn" style="display: none;">‚è∏ Stop</button>
                        <div class="beat-indicator"></div>
                    </div>
                </div>
            </div>

            <!-- Drum Kit Section - Takes Most Space -->
            <div class="drum-kit-section">
                <h2 class="section-title">Interactive Drum Kit</h2>
                <div class="drum-container">
                    <!-- Top Left - Tom1 -->
                    <div class="drum-zone tom1-zone">
                        <div class="drum tom1-left" data-sound="tom1" data-hand="üëà L">
                            <div>Tom 1</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Left</div>
                        </div>
                        <div class="drum tom1-right" data-sound="tom1" data-hand="üëâ R">
                            <div>Tom 1</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Right</div>
                        </div>
                    </div>

                    <!-- Top Right - Tom2 -->
                    <div class="drum-zone tom2-zone">
                        <div class="drum tom2-left" data-sound="tom2" data-hand="üëà L">
                            <div>Tom 2</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Left</div>
                        </div>
                        <div class="drum tom2-right" data-sound="tom2" data-hand="üëâ R">
                            <div>Tom 2</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Right</div>
                        </div>
                    </div>

                    <!-- Bottom Left - Snare -->
                    <div class="drum-zone snare-zone">
                        <div class="drum snare-left" data-sound="snare" data-hand="üëà L">
                            <div>Snare</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Left</div>
                        </div>
                        <div class="drum snare-right" data-sound="snare" data-hand="üëâ R">
                            <div>Snare</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Right</div>
                        </div>
                    </div>

                    <!-- Bottom Right - Tom3 -->
                    <div class="drum-zone tom3-zone">
                        <div class="drum tom3-left" data-sound="tom3" data-hand="üëà L">
                            <div>Tom 3</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Left</div>
                        </div>
                        <div class="drum tom3-right" data-sound="tom3" data-hand="üëâ R">
                            <div>Tom 3</div>
                            <div style="font-size: 0.6em; margin-top: 5px;">Right</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patterns Section - At Bottom -->
        <div class="patterns-section">
            <h2 class="patterns-title">8 Simple Drum Patterns</h2>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-symbol">SD</span> Snare (Snare Drum)
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">T1</span> Tom 1 (High Tom)
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">T2</span> Tom 2 (Mid Tom)
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">T3</span> Tom 3 (Low Tom)
                </div>
            </div>

            <div class="patterns-grid" id="patternsGrid"></div>
        </div>
    </div>

    <script>
        // 8 Simplified Drum Patterns - Using only Snare, Tom1, Tom2, Tom3
        const drumPatterns = [
            {
                name: "1. Basic Single Hits",
                description: "Simplest single hit rhythm for beginners",
                beats: 4,
                notation: `Beat: 1   2   3   4
SD:   x   x   x   x`,
                pattern: [
                    {beat: 1, drums: ['snare']},
                    {beat: 2, drums: ['snare']},
                    {beat: 3, drums: ['snare']},
                    {beat: 4, drums: ['snare']}
                ]
            },
            {
                name: "2. Up Down Alternate",
                description: "Tom1 and Snare alternating practice",
                beats: 4,
                notation: `Beat: 1   2   3   4
T1:   x   -   x   -
SD:   -   x   -   x`,
                pattern: [
                    {beat: 1, drums: ['tom1']},
                    {beat: 2, drums: ['snare']},
                    {beat: 3, drums: ['tom1']},
                    {beat: 4, drums: ['snare']}
                ]
            },
            {
                name: "3. Three Tom Roll",
                description: "Tom1, Tom2, Tom3 in sequence",
                beats: 3,
                notation: `Beat: 1   2   3
T1:   x   -   -
T2:   -   x   -
T3:   -   -   x`,
                pattern: [
                    {beat: 1, drums: ['tom1']},
                    {beat: 2, drums: ['tom2']},
                    {beat: 3, drums: ['tom3']}
                ]
            },
            {
                name: "4. Double Hit Practice",
                description: "Two hits per drum, practice coordination",
                beats: 4,
                notation: `Beat: 1   2   3   4
T1:   x   x   -   -
SD:   -   -   x   x`,
                pattern: [
                    {beat: 1, drums: ['tom1']},
                    {beat: 2, drums: ['tom1']},
                    {beat: 3, drums: ['snare']},
                    {beat: 4, drums: ['snare']}
                ]
            },
            {
                name: "5. Descending Roll",
                description: "Roll from high tom down to snare",
                beats: 4,
                notation: `Beat: 1   2   3   4
T1:   x   -   -   -
T2:   -   x   -   -
T3:   -   -   x   -
SD:   -   -   -   x`,
                pattern: [
                    {beat: 1, drums: ['tom1']},
                    {beat: 2, drums: ['tom2']},
                    {beat: 3, drums: ['tom3']},
                    {beat: 4, drums: ['snare']}
                ]
            },
            {
                name: "6. Echo Practice",
                description: "Tom1 hits with others following",
                beats: 4,
                notation: `Beat: 1   2   3   4
T1:   x   x   x   x
T2:   -   x   -   -
T3:   -   -   x   -
SD:   -   -   -   x`,
                pattern: [
                    {beat: 1, drums: ['tom1']},
                    {beat: 2, drums: ['tom1', 'tom2']},
                    {beat: 3, drums: ['tom1', 'tom3']},
                    {beat: 4, drums: ['tom1', 'snare']}
                ]
            },
            {
                name: "7. Climbing Stairs",
                description: "Climb from snare up to tom1",
                beats: 4,
                notation: `Beat: 1   2   3   4
SD:   x   -   -   -
T3:   -   x   -   -
T2:   -   -   x   -
T1:   -   -   -   x`,
                pattern: [
                    {beat: 1, drums: ['snare']},
                    {beat: 2, drums: ['tom3']},
                    {beat: 3, drums: ['tom2']},
                    {beat: 4, drums: ['tom1']}
                ]
            },
            {
                name: "8. Strong Weak Contrast",
                description: "Snare strong beat, Tom weak beat",
                beats: 4,
                notation: `Beat: 1   2   3   4
SD:   x   -   x   -
T2:   -   x   -   x`,
                pattern: [
                    {beat: 1, drums: ['snare']},
                    {beat: 2, drums: ['tom2']},
                    {beat: 3, drums: ['snare']},
                    {beat: 4, drums: ['tom2']}
                ]
            }
        ];

        // Audio Context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create authentic acoustic jazz drum sounds
        function playDrum(drumType) {
            const now = audioContext.currentTime;
            
            if (drumType === 'snare') {
                // ACOUSTIC SNARE - Traditional jazz snare with natural resonance
                
                // 1. Drum shell fundamental (wood body resonance)
                const fundamental = audioContext.createOscillator();
                fundamental.type = 'sine';
                fundamental.frequency.setValueAtTime(200, now);
                fundamental.frequency.exponentialRampToValueAtTime(180, now + 0.05);
                fundamental.frequency.exponentialRampToValueAtTime(160, now + 0.15);
                
                // 2. Second harmonic (shell mode)
                const harmonic2 = audioContext.createOscillator();
                harmonic2.type = 'sine';
                harmonic2.frequency.setValueAtTime(330, now);
                harmonic2.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                
                // 3. Third harmonic (higher overtone)
                const harmonic3 = audioContext.createOscillator();
                harmonic3.type = 'sine';
                harmonic3.frequency.setValueAtTime(480, now);
                harmonic3.frequency.exponentialRampToValueAtTime(440, now + 0.08);
                
                const toneGain = audioContext.createGain();
                toneGain.gain.setValueAtTime(0.5, now);
                toneGain.gain.setValueAtTime(0.4, now + 0.01);
                toneGain.gain.exponentialRampToValueAtTime(0.1, now + 0.08);
                toneGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                
                fundamental.connect(toneGain);
                harmonic2.connect(toneGain);
                harmonic3.connect(toneGain);
                
                // 4. Snare wires (metal rattling sound)
                const wireNoise = audioContext.createBufferSource();
                const wireBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.25, audioContext.sampleRate);
                const wireData = wireBuffer.getChannelData(0);
                
                // Generate metallic noise with specific characteristics
                for (let i = 0; i < wireBuffer.length; i++) {
                    const decay = Math.exp(-i / audioContext.sampleRate * 10);
                    wireData[i] = (Math.random() * 2 - 1) * decay;
                }
                wireNoise.buffer = wireBuffer;
                
                // High-pass for wire brightness
                const wireHP = audioContext.createBiquadFilter();
                wireHP.type = 'highpass';
                wireHP.frequency.value = 1500;
                wireHP.Q.value = 0.5;
                
                // Band-pass for wire character
                const wireBP = audioContext.createBiquadFilter();
                wireBP.type = 'bandpass';
                wireBP.frequency.value = 4000;
                wireBP.Q.value = 1.5;
                
                const wireGain = audioContext.createGain();
                wireGain.gain.setValueAtTime(0.7, now);
                wireGain.gain.exponentialRampToValueAtTime(0.2, now + 0.1);
                wireGain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
                
                wireNoise.connect(wireHP);
                wireHP.connect(wireBP);
                wireBP.connect(wireGain);
                
                // 5. Stick attack (transient)
                const attackNoise = audioContext.createBufferSource();
                const attackBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.02, audioContext.sampleRate);
                const attackData = attackBuffer.getChannelData(0);
                for (let i = 0; i < attackBuffer.length; i++) {
                    attackData[i] = (Math.random() * 2 - 1) * (1 - i / attackBuffer.length);
                }
                attackNoise.buffer = attackBuffer;
                
                const attackFilter = audioContext.createBiquadFilter();
                attackFilter.type = 'lowpass';
                attackFilter.frequency.value = 3000;
                
                const attackGain = audioContext.createGain();
                attackGain.gain.setValueAtTime(0.6, now);
                attackGain.gain.exponentialRampToValueAtTime(0.01, now + 0.02);
                
                attackNoise.connect(attackFilter);
                attackFilter.connect(attackGain);
                
                // Room ambience
                const reverb = audioContext.createGain();
                reverb.gain.value = 0.15;
                
                toneGain.connect(reverb);
                wireGain.connect(reverb);
                attackGain.connect(reverb);
                
                toneGain.connect(audioContext.destination);
                wireGain.connect(audioContext.destination);
                attackGain.connect(audioContext.destination);
                reverb.connect(audioContext.destination);
                
                fundamental.start(now);
                harmonic2.start(now);
                harmonic3.start(now);
                wireNoise.start(now);
                attackNoise.start(now);
                
                fundamental.stop(now + 0.2);
                harmonic2.stop(now + 0.15);
                harmonic3.stop(now + 0.12);
                wireNoise.stop(now + 0.25);
                attackNoise.stop(now + 0.02);
                
            } else if (drumType === 'tom1') {
                // TOM 1 - High acoustic tom (10" or 12")
                const baseFreq = 220;
                
                // Fundamental
                const fund = audioContext.createOscillator();
                fund.type = 'sine';
                fund.frequency.setValueAtTime(baseFreq, now);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.85, now + 0.1);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.75, now + 0.3);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.65, now + 0.5);
                
                // Overtone 1
                const ov1 = audioContext.createOscillator();
                ov1.type = 'sine';
                ov1.frequency.setValueAtTime(baseFreq * 1.6, now);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.4, now + 0.15);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.2, now + 0.35);
                
                // Overtone 2
                const ov2 = audioContext.createOscillator();
                ov2.type = 'sine';
                ov2.frequency.setValueAtTime(baseFreq * 2.3, now);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 2.0, now + 0.12);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 1.7, now + 0.25);
                
                // Shell
                const shell = audioContext.createOscillator();
                shell.type = 'triangle';
                shell.frequency.setValueAtTime(baseFreq * 0.8, now);
                shell.frequency.exponentialRampToValueAtTime(baseFreq * 0.6, now + 0.4);
                
                // Attack
                const att = audioContext.createBufferSource();
                const attBuf = audioContext.createBuffer(1, audioContext.sampleRate * 0.03, audioContext.sampleRate);
                const attData = attBuf.getChannelData(0);
                for (let i = 0; i < attBuf.length; i++) {
                    const env = 1 - (i / attBuf.length);
                    attData[i] = (Math.random() * 2 - 1) * env * env;
                }
                att.buffer = attBuf;
                
                const attFilt = audioContext.createBiquadFilter();
                attFilt.type = 'lowpass';
                attFilt.frequency.value = 1200;
                
                const attGain = audioContext.createGain();
                attGain.gain.setValueAtTime(0.5, now);
                attGain.gain.exponentialRampToValueAtTime(0.01, now + 0.03);
                
                att.connect(attFilt);
                attFilt.connect(attGain);
                
                // Main gain
                const mainGain = audioContext.createGain();
                mainGain.gain.setValueAtTime(0, now);
                mainGain.gain.linearRampToValueAtTime(0.85, now + 0.005);
                mainGain.gain.setValueAtTime(0.75, now + 0.02);
                mainGain.gain.exponentialRampToValueAtTime(0.5, now + 0.1);
                mainGain.gain.exponentialRampToValueAtTime(0.2, now + 0.3);
                mainGain.gain.exponentialRampToValueAtTime(0.05, now + 0.5);
                mainGain.gain.exponentialRampToValueAtTime(0.01, now + 0.7);
                
                const g1 = audioContext.createGain();
                g1.gain.value = 1.0;
                const g2 = audioContext.createGain();
                g2.gain.value = 0.4;
                const g3 = audioContext.createGain();
                g3.gain.value = 0.2;
                const g4 = audioContext.createGain();
                g4.gain.value = 0.3;
                
                fund.connect(g1);
                ov1.connect(g2);
                ov2.connect(g3);
                shell.connect(g4);
                
                g1.connect(mainGain);
                g2.connect(mainGain);
                g3.connect(mainGain);
                g4.connect(mainGain);
                
                const rev = audioContext.createGain();
                rev.gain.value = 0.12;
                
                mainGain.connect(rev);
                mainGain.connect(audioContext.destination);
                rev.connect(audioContext.destination);
                attGain.connect(audioContext.destination);
                
                fund.start(now);
                ov1.start(now);
                ov2.start(now);
                shell.start(now);
                att.start(now);
                
                fund.stop(now + 0.7);
                ov1.stop(now + 0.5);
                ov2.stop(now + 0.35);
                shell.stop(now + 0.6);
                att.stop(now + 0.03);
                
            } else if (drumType === 'tom2') {
                // TOM 2 - Mid acoustic tom (13" or 14")
                const baseFreq = 165;
                
                const fund = audioContext.createOscillator();
                fund.type = 'sine';
                fund.frequency.setValueAtTime(baseFreq, now);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.85, now + 0.1);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.75, now + 0.3);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.65, now + 0.5);
                
                const ov1 = audioContext.createOscillator();
                ov1.type = 'sine';
                ov1.frequency.setValueAtTime(baseFreq * 1.6, now);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.4, now + 0.15);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.2, now + 0.35);
                
                const ov2 = audioContext.createOscillator();
                ov2.type = 'sine';
                ov2.frequency.setValueAtTime(baseFreq * 2.3, now);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 2.0, now + 0.12);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 1.7, now + 0.25);
                
                const shell = audioContext.createOscillator();
                shell.type = 'triangle';
                shell.frequency.setValueAtTime(baseFreq * 0.8, now);
                shell.frequency.exponentialRampToValueAtTime(baseFreq * 0.6, now + 0.4);
                
                const att = audioContext.createBufferSource();
                const attBuf = audioContext.createBuffer(1, audioContext.sampleRate * 0.03, audioContext.sampleRate);
                const attData = attBuf.getChannelData(0);
                for (let i = 0; i < attBuf.length; i++) {
                    const env = 1 - (i / attBuf.length);
                    attData[i] = (Math.random() * 2 - 1) * env * env;
                }
                att.buffer = attBuf;
                
                const attFilt = audioContext.createBiquadFilter();
                attFilt.type = 'lowpass';
                attFilt.frequency.value = 1200;
                
                const attGain = audioContext.createGain();
                attGain.gain.setValueAtTime(0.5, now);
                attGain.gain.exponentialRampToValueAtTime(0.01, now + 0.03);
                
                att.connect(attFilt);
                attFilt.connect(attGain);
                
                const mainGain = audioContext.createGain();
                mainGain.gain.setValueAtTime(0, now);
                mainGain.gain.linearRampToValueAtTime(0.85, now + 0.005);
                mainGain.gain.setValueAtTime(0.75, now + 0.02);
                mainGain.gain.exponentialRampToValueAtTime(0.5, now + 0.1);
                mainGain.gain.exponentialRampToValueAtTime(0.2, now + 0.3);
                mainGain.gain.exponentialRampToValueAtTime(0.05, now + 0.5);
                mainGain.gain.exponentialRampToValueAtTime(0.01, now + 0.7);
                
                const g1 = audioContext.createGain();
                g1.gain.value = 1.0;
                const g2 = audioContext.createGain();
                g2.gain.value = 0.4;
                const g3 = audioContext.createGain();
                g3.gain.value = 0.2;
                const g4 = audioContext.createGain();
                g4.gain.value = 0.3;
                
                fund.connect(g1);
                ov1.connect(g2);
                ov2.connect(g3);
                shell.connect(g4);
                
                g1.connect(mainGain);
                g2.connect(mainGain);
                g3.connect(mainGain);
                g4.connect(mainGain);
                
                const rev = audioContext.createGain();
                rev.gain.value = 0.12;
                
                mainGain.connect(rev);
                mainGain.connect(audioContext.destination);
                rev.connect(audioContext.destination);
                attGain.connect(audioContext.destination);
                
                fund.start(now);
                ov1.start(now);
                ov2.start(now);
                shell.start(now);
                att.start(now);
                
                fund.stop(now + 0.7);
                ov1.stop(now + 0.5);
                ov2.stop(now + 0.35);
                shell.stop(now + 0.6);
                att.stop(now + 0.03);
                
            } else if (drumType === 'tom3') {
                // TOM 3 - Floor tom (16" or 18")
                const baseFreq = 110;
                
                const fund = audioContext.createOscillator();
                fund.type = 'sine';
                fund.frequency.setValueAtTime(baseFreq, now);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.85, now + 0.1);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.75, now + 0.3);
                fund.frequency.exponentialRampToValueAtTime(baseFreq * 0.65, now + 0.5);
                
                const ov1 = audioContext.createOscillator();
                ov1.type = 'sine';
                ov1.frequency.setValueAtTime(baseFreq * 1.6, now);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.4, now + 0.15);
                ov1.frequency.exponentialRampToValueAtTime(baseFreq * 1.2, now + 0.35);
                
                const ov2 = audioContext.createOscillator();
                ov2.type = 'sine';
                ov2.frequency.setValueAtTime(baseFreq * 2.3, now);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 2.0, now + 0.12);
                ov2.frequency.exponentialRampToValueAtTime(baseFreq * 1.7, now + 0.25);
                
                const shell = audioContext.createOscillator();
                shell.type = 'triangle';
                shell.frequency.setValueAtTime(baseFreq * 0.8, now);
                shell.frequency.exponentialRampToValueAtTime(baseFreq * 0.6, now + 0.4);
                
                const att = audioContext.createBufferSource();
                const attBuf = audioContext.createBuffer(1, audioContext.sampleRate * 0.03, audioContext.sampleRate);
                const attData = attBuf.getChannelData(0);
                for (let i = 0; i < attBuf.length; i++) {
                    const env = 1 - (i / attBuf.length);
                    attData[i] = (Math.random() * 2 - 1) * env * env;
                }
                att.buffer = attBuf;
                
                const attFilt = audioContext.createBiquadFilter();
                attFilt.type = 'lowpass';
                attFilt.frequency.value = 1200;
                
                const attGain = audioContext.createGain();
                attGain.gain.setValueAtTime(0.5, now);
                attGain.gain.exponentialRampToValueAtTime(0.01, now + 0.03);
                
                att.connect(attFilt);
                attFilt.connect(attGain);
                
                const mainGain = audioContext.createGain();
                mainGain.gain.setValueAtTime(0, now);
                mainGain.gain.linearRampToValueAtTime(0.85, now + 0.005);
                mainGain.gain.setValueAtTime(0.75, now + 0.02);
                mainGain.gain.exponentialRampToValueAtTime(0.5, now + 0.1);
                mainGain.gain.exponentialRampToValueAtTime(0.2, now + 0.3);
                mainGain.gain.exponentialRampToValueAtTime(0.05, now + 0.5);
                mainGain.gain.exponentialRampToValueAtTime(0.01, now + 0.7);
                
                const g1 = audioContext.createGain();
                g1.gain.value = 1.0;
                const g2 = audioContext.createGain();
                g2.gain.value = 0.4;
                const g3 = audioContext.createGain();
                g3.gain.value = 0.2;
                const g4 = audioContext.createGain();
                g4.gain.value = 0.3;
                
                fund.connect(g1);
                ov1.connect(g2);
                ov2.connect(g3);
                shell.connect(g4);
                
                g1.connect(mainGain);
                g2.connect(mainGain);
                g3.connect(mainGain);
                g4.connect(mainGain);
                
                const rev = audioContext.createGain();
                rev.gain.value = 0.12;
                
                mainGain.connect(rev);
                mainGain.connect(audioContext.destination);
                rev.connect(audioContext.destination);
                attGain.connect(audioContext.destination);
                
                fund.start(now);
                ov1.start(now);
                ov2.start(now);
                shell.start(now);
                att.start(now);
                
                fund.stop(now + 0.7);
                ov1.stop(now + 0.5);
                ov2.stop(now + 0.35);
                shell.stop(now + 0.6);
                att.stop(now + 0.03);
            }
        }

        // Touch and click event handlers
        document.querySelectorAll('.drum').forEach(drum => {
            // Click support
            drum.addEventListener('click', function() {
                const sound = this.dataset.sound;
                playDrum(sound);
                this.classList.add('hit');
                setTimeout(() => this.classList.remove('hit'), 300);
            });
            
            // Touch support - detect tap vs scroll
            let touchStartY = 0;
            let touchStartTime = 0;
            
            drum.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }, {passive: true});
            
            drum.addEventListener('touchend', function(e) {
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndTime = Date.now();
                const deltaY = Math.abs(touchEndY - touchStartY);
                const deltaTime = touchEndTime - touchStartTime;
                
                // If movement is small and quick, it's a tap
                if (deltaY < 10 && deltaTime < 200) {
                    e.preventDefault();
                    const sound = this.dataset.sound;
                    playDrum(sound);
                    this.classList.add('hit');
                    setTimeout(() => this.classList.remove('hit'), 300);
                }
            });
        });

        // ÁØÄÊãçÂô®ËÆäÊï∏
        let bpm = 90;
        let isPlaying = false;
        let intervalId = null;
        let currentBeat = 0;
        let currentPattern = null;
        let patternIntervalId = null;

        const bpmDisplay = document.getElementById('bpmDisplay');
        const bpmSlider = document.getElementById('bpmSlider');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const beatIndicator = document.querySelector('.beat-indicator');

        // ÂâµÂª∫ÂãïÊÖãÁØÄÊãçÊåáÁ§∫Âô®
        function createBeatIndicator(beats) {
            beatIndicator.innerHTML = '';
            for (let i = 0; i < beats; i++) {
                const dot = document.createElement('div');
                dot.className = 'beat-dot';
                beatIndicator.appendChild(dot);
            }
        }

        // BPMÊéßÂà∂
        document.getElementById('bpmUp').addEventListener('click', () => {
            bpm = Math.min(240, bpm + 5);
            updateBPM();
        });

        document.getElementById('bpmDown').addEventListener('click', () => {
            bpm = Math.max(40, bpm - 5);
            updateBPM();
        });

        bpmSlider.addEventListener('input', (e) => {
            bpm = parseInt(e.target.value);
            updateBPM();
        });

        function updateBPM() {
            bpmDisplay.textContent = bpm;
            bpmSlider.value = bpm;
            if (isPlaying) {
                stopMetronome();
                startMetronome();
            }
        }

        // ÁØÄÊãçÂô®ÂäüËÉΩ
        function startMetronome() {
            isPlaying = true;
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            currentBeat = 0;
            
            // Disable scrolling when playing
            document.body.classList.add('playing');

            // Use 4 beats by default if no pattern selected
            const beats = currentPattern ? currentPattern.beats : 4;
            const interval = 60000 / bpm;

            intervalId = setInterval(() => {
                // Play metronome click
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = currentBeat === 0 ? 1000 : 800;
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);

                // Update visual indicator
                const beatDots = document.querySelectorAll('.beat-dot');
                beatDots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentBeat);
                });

                currentBeat = (currentBeat + 1) % beats;
            }, interval);

            // Only play selected pattern if user has chosen one
            if (currentPattern) {
                playPattern(currentPattern);
            }
        }

        function stopMetronome() {
            isPlaying = false;
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            
            // Re-enable scrolling when stopped
            document.body.classList.remove('playing');
            
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            if (patternIntervalId) {
                clearInterval(patternIntervalId);
                patternIntervalId = null;
            }

            const beatDots = document.querySelectorAll('.beat-dot');
            beatDots.forEach(dot => dot.classList.remove('active'));
            currentBeat = 0;
        }

        startBtn.addEventListener('click', startMetronome);
        stopBtn.addEventListener('click', stopMetronome);

        // Êí≠ÊîæÈºìÈªû
        function playPattern(pattern) {
            if (patternIntervalId) {
                clearInterval(patternIntervalId);
            }

            const barDuration = (60000 / bpm) * pattern.beats; // ‰∏ÄÂ∞èÁØÄÁöÑÊôÇÈï∑
            
            patternIntervalId = setInterval(() => {
                const beatTime = 60000 / bpm; // ÊØè‰∏ÄÊãçÁöÑÊôÇÈï∑
                
                pattern.pattern.forEach((note) => {
                    setTimeout(() => {
                        note.drums.forEach(drum => {
                            playDrum(drum);
                            const drumElements = document.querySelectorAll(`[data-sound="${drum}"]`);
                            drumElements.forEach(drumElement => {
                                drumElement.classList.add('hit');
                                setTimeout(() => drumElement.classList.remove('hit'), 200);
                            });
                        });
                    }, (note.beat - 1) * beatTime);
                });

            }, barDuration);
        }

        // Ê∏≤ÊüìÈºìÈªûÂç°Áâá
        const patternsGrid = document.getElementById('patternsGrid');
        drumPatterns.forEach((pattern, index) => {
            const card = document.createElement('div');
            card.className = 'pattern-card';
            card.innerHTML = `
                <div class="pattern-name">${pattern.name}</div>
                <div class="pattern-description">${pattern.description}</div>
                <div class="pattern-notation">${pattern.notation}</div>
            `;
            
            card.addEventListener('click', function() {
                // If clicking the already active card, deselect it
                if (this.classList.contains('active')) {
                    this.classList.remove('active');
                    currentPattern = null;
                    createBeatIndicator(4); // Reset to 4 beats
                    
                    // If playing, restart with just metronome
                    if (isPlaying) {
                        stopMetronome();
                        startMetronome();
                    }
                } else {
                    // Select new pattern
                    document.querySelectorAll('.pattern-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    currentPattern = pattern;
                    
                    // Create beat indicator for this pattern
                    createBeatIndicator(pattern.beats);
                    
                    // If playing, restart with new pattern
                    if (isPlaying) {
                        stopMetronome();
                        startMetronome();
                    }
                }
            });
            
            patternsGrid.appendChild(card);
        });

        // Don't select any pattern by default - let user choose
        // Initialize with 4 beats for metronome indicator
        createBeatIndicator(4);
        currentPattern = null;
    </script>
</body>
</html>
